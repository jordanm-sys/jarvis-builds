<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#0d1117">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<title>Jarvis Dashboard v8</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0d1117;--surface:#161b22;--surface2:#21262d;--border:#30363d;--text:#e6edf3;--text2:#8b949e;--accent:#58a6ff;--green:#3fb950;--yellow:#d29922;--red:#f85149;--orange:#d29922;--radius:8px}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden}
header{padding:16px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:var(--surface)}
header h1{font-size:20px;font-weight:600;letter-spacing:-.5px}
header h1 span{color:var(--accent)}
.header-right{display:flex;align-items:center;gap:12px}
.btn{background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:var(--radius);cursor:pointer;font-size:14px;font-weight:500;transition:opacity .2s}
.btn:hover{opacity:.85}
.btn-sm{padding:6px 12px;font-size:12px}

/* Top nav */
.top-tabs{display:flex;gap:0;background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px}
.top-tab{padding:12px 24px;font-size:15px;font-weight:600;color:var(--text2);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;user-select:none}
.top-tab:hover{color:var(--text)}
.top-tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* Sub tabs */
.sub-tabs{display:flex;gap:4px;padding:0 24px;background:var(--bg);border-bottom:1px solid var(--border)}
.sub-tab{padding:8px 16px;font-size:13px;font-weight:500;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s}
.sub-tab:hover{color:var(--text)}
.sub-tab.active{color:var(--accent);border-bottom-color:var(--accent)}

.section{display:none;flex:1;overflow:hidden;flex-direction:column}
.section.active{display:flex}
.sub-section{display:none;flex:1;overflow-y:auto;padding:20px 24px}
.sub-section.active{display:block}

/* Board */
.board{display:flex;gap:16px;padding:20px 24px;flex:1;overflow-x:auto}
.column{background:var(--surface);border-radius:var(--radius);min-width:280px;width:280px;display:flex;flex-direction:column;border:1px solid var(--border)}
.column-header{padding:14px 16px;font-weight:600;font-size:14px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border)}
.column-header .count{background:var(--surface2);color:var(--text2);font-size:12px;padding:2px 8px;border-radius:10px;font-weight:500}
.column-body{padding:8px;flex:1;overflow-y:auto;min-height:60px;transition:background .2s}
.column-body.drag-over{background:rgba(88,166,255,.06)}
.card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:8px;cursor:grab;transition:transform .15s,box-shadow .15s,opacity .15s;position:relative}
.card:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
.card.dragging{opacity:.4;transform:rotate(2deg)}
.card-title{font-weight:600;font-size:14px;margin-bottom:4px}
.card-desc{color:var(--text2);font-size:12px;line-height:1.4;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.card-meta{display:flex;align-items:center;justify-content:space-between;font-size:11px;color:var(--text2)}
.priority{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
.priority.low{background:var(--green)}.priority.medium{background:var(--yellow)}.priority.high{background:var(--red)}
.card-actions{position:absolute;top:8px;right:8px;opacity:0;transition:opacity .15s;display:flex;gap:4px}
.card:hover .card-actions{opacity:1}
.card-actions button{background:none;border:none;color:var(--text2);cursor:pointer;font-size:14px;padding:2px 4px;border-radius:4px}
.card-actions button:hover{background:var(--border);color:var(--red)}

/* Projects */
.projects-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
.project-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:transform .15s,box-shadow .15s;position:relative;overflow:hidden;display:flex;flex-direction:column}
.project-card:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.project-card .card-actions{opacity:0;transition:opacity .15s;position:absolute;top:12px;right:12px;display:flex;gap:4px}
.project-card:hover .card-actions{opacity:1}
.project-card .card-actions button{background:none;border:none;color:var(--text2);cursor:pointer;font-size:14px;padding:2px 4px;border-radius:4px}
.project-card .card-actions button:hover{background:var(--border);color:var(--red)}
.project-name{font-weight:600;font-size:16px;margin-bottom:8px}
.project-desc{color:var(--text2);font-size:13px;line-height:1.5;margin-bottom:12px}
.project-status{display:inline-block;padding:2px 10px;border-radius:10px;font-size:11px;font-weight:600;text-transform:uppercase}
.project-status.active{background:rgba(63,185,80,.15);color:var(--green)}
.project-status.completed{background:rgba(88,166,255,.15);color:var(--accent)}
.project-status.incomplete{background:rgba(248,81,73,.15);color:var(--red)}
.incomplete-reason{color:var(--red);font-size:12px;line-height:1.4;margin-bottom:8px;padding:6px 10px;background:rgba(248,81,73,.08);border-radius:6px;border-left:3px solid var(--red)}
.review-badge{display:inline-block;padding:2px 10px;border-radius:10px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px;cursor:pointer;transition:all .2s;min-width:80px;max-width:80px;text-align:center;flex-shrink:0}
.review-badge:hover{opacity:.8}
.review-badge.needs-review{background:rgba(210,153,34,.2);color:var(--yellow);border:1px solid rgba(210,153,34,.3)}
.review-badge.reviewed{background:rgba(63,185,80,.15);color:var(--green);border:1px solid rgba(63,185,80,.3)}
.project-footer{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);margin-top:auto}
.project-links{display:flex;gap:8px;white-space:nowrap;margin-left:auto;align-items:center}
.project-link{color:var(--accent);text-decoration:none;font-size:12px;display:inline-flex;align-items:center;gap:4px}
.project-link:hover{text-decoration:underline}
.category-section{margin-bottom:28px}
.category-header{font-size:16px;font-weight:600;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.category-header .cat-icon{font-size:18px}
.category-header .cat-count{background:var(--surface2);color:var(--text2);font-size:12px;padding:2px 8px;border-radius:10px;font-weight:500}

/* Stocks shared */
.ticker-bar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:24px}
.ticker-chip{display:inline-flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:6px 14px;font-size:13px;font-weight:600;transition:all .2s}
.ticker-chip .currency{font-size:10px;color:var(--text2);font-weight:400}
.ticker-chip .remove-ticker{background:none;border:none;color:var(--text2);cursor:pointer;font-size:14px;padding:0 0 0 4px;line-height:1;transition:color .15s}
.ticker-chip .remove-ticker:hover{color:var(--red)}
.add-ticker-form{display:inline-flex;align-items:center;gap:6px}
.add-ticker-form input{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:6px 12px;color:var(--text);font-size:13px;width:90px;font-family:inherit}
.add-ticker-form select{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:6px 8px;color:var(--text);font-size:12px;font-family:inherit}

/* Briefings */
.briefing-list{display:flex;flex-direction:column;gap:16px}
.briefing-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.briefing-date-header{padding:14px 20px;font-weight:600;font-size:15px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.briefing-date-header .date-label{display:flex;align-items:center;gap:8px}
.briefing-date-header .date-label span{font-size:12px;color:var(--text2);font-weight:400}
.briefing-body{padding:20px}
.briefing-body .summary{margin-bottom:16px;font-size:14px;line-height:1.6;color:var(--text)}
.briefing-body .stock-row{display:grid;grid-template-columns:80px 80px 1fr;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);align-items:center;font-size:13px}
.briefing-body .stock-row:last-child{border-bottom:none}
.briefing-body .stock-symbol{font-weight:700;color:var(--text)}
.briefing-body .stock-change.up{color:var(--green)}
.briefing-body .stock-change.down{color:var(--red)}
.briefing-body .stock-change.flat{color:var(--text2)}
.briefing-body .stock-note{color:var(--text2)}
.briefing-delete{background:none;border:none;color:var(--text2);cursor:pointer;font-size:13px;padding:4px 8px;border-radius:4px;transition:all .15s}
.briefing-delete:hover{background:var(--border);color:var(--red)}
.no-briefings{text-align:center;padding:60px 20px;color:var(--text2)}
.no-briefings .icon{font-size:48px;margin-bottom:12px}
.no-briefings p{font-size:14px}

/* Earnings table */
.earnings-table{width:100%;border-collapse:collapse;font-size:13px}
.earnings-table th{text-align:left;padding:10px 12px;border-bottom:2px solid var(--border);color:var(--text2);font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:.5px}
.earnings-table td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:top}
.earnings-table tr:hover td{background:var(--surface2)}
.earnings-table .sym{font-weight:700;font-size:14px}
.earnings-table .date-cell{white-space:nowrap}
.earnings-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;white-space:nowrap}
.earnings-badge.upcoming{background:rgba(210,153,34,.2);color:var(--yellow)}
.earnings-badge.imminent{background:rgba(248,81,73,.2);color:var(--red)}
.earnings-badge.reported{background:rgba(63,185,80,.15);color:var(--green)}
.earnings-badge.tbd{background:var(--surface2);color:var(--text2)}
.scenario{font-size:12px;line-height:1.5;color:var(--text2);margin-top:2px}
.scenario .bull{color:var(--green)}
.scenario .bear{color:var(--red)}
.scenario-label{font-weight:600;font-size:11px;margin-right:4px}
.source-tag{display:block;font-size:10px;color:var(--text2);background:var(--surface2);padding:1px 6px;border-radius:4px;margin-top:4px;width:fit-content}
.earnings-empty{text-align:center;padding:60px 20px;color:var(--text2)}

/* Market Insights */
.market-day{margin-bottom:24px}
.market-day-header{font-size:15px;font-weight:600;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.market-day-header span{font-size:12px;color:var(--text2);font-weight:400}
.market-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px}
.market-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;position:relative;transition:transform .15s,box-shadow .15s}
.market-card:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
.market-card .card-actions{opacity:0;transition:opacity .15s;position:absolute;top:8px;right:8px}
.market-card:hover .card-actions{opacity:1}
.market-card .card-actions button{background:none;border:none;color:var(--text2);cursor:pointer;font-size:13px;padding:2px 4px;border-radius:4px}
.market-card .card-actions button:hover{color:var(--red)}
.market-type-badge{display:inline-block;padding:2px 10px;border-radius:10px;font-size:11px;font-weight:600;text-transform:uppercase;margin-bottom:8px}
.market-type-badge.shift{background:rgba(88,166,255,.15);color:var(--accent)}
.market-type-badge.opportunity{background:rgba(63,185,80,.15);color:var(--green)}
.market-type-badge.warning{background:rgba(248,81,73,.15);color:var(--red)}
.market-type-badge.trend{background:rgba(210,153,34,.2);color:var(--yellow)}
.market-title{font-weight:700;font-size:15px;margin-bottom:6px}
.market-tickers{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px}
.market-ticker{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:2px 8px;font-size:11px;font-weight:600}
.market-desc{color:var(--text2);font-size:13px;line-height:1.6;margin-bottom:10px}
.market-thesis{font-size:12px;line-height:1.5;padding:8px 12px;background:var(--surface2);border-radius:6px;border-left:3px solid var(--accent)}
.market-thesis .label{font-weight:600;font-size:11px;text-transform:uppercase;color:var(--accent);margin-bottom:2px}
.market-conviction{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:600;margin-top:8px}
.conviction-high{color:var(--green)}
.conviction-med{color:var(--yellow)}
.conviction-low{color:var(--text2)}

/* Options Flow */
.options-alert-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px}
.options-alert-card.bullish{border-left:3px solid var(--green)}
.options-alert-card.bearish{border-left:3px solid var(--red)}
.options-badge{font-size:11px;font-weight:700;text-transform:uppercase;padding:3px 10px;border-radius:10px;display:inline-block}
.options-badge.bullish{background:rgba(63,185,80,.15);color:var(--green)}
.options-badge.bearish{background:rgba(248,81,73,.15);color:var(--red)}
.options-score{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0}
.options-score.high{background:rgba(248,81,73,.2);color:var(--red)}
.options-score.med{background:rgba(210,153,34,.2);color:var(--yellow)}
.options-score.low{background:rgba(63,185,80,.15);color:var(--green)}
.options-meta{flex:1;min-width:0}
.options-meta .sym{font-size:16px;font-weight:700}
.options-meta .strike{font-size:13px;color:var(--text2);margin-top:2px}
.options-stats{display:flex;gap:20px;flex-wrap:wrap;margin-top:8px}
.options-stat{text-align:center}
.options-stat .val{font-size:14px;font-weight:700}
.options-stat .lbl{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.options-scan-time{font-size:12px;color:var(--text2);margin-bottom:16px}
.options-empty{text-align:center;padding:60px 20px;color:var(--text2)}

/* Insider Trading */
.insider-summary-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center}
.insider-summary-card .label{font-size:12px;color:var(--text2);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
.insider-summary-card .value{font-size:24px;font-weight:700}
.insider-summary-card .sub{font-size:12px;color:var(--text2);margin-top:2px}
.insider-summary-card.buy{border-left:3px solid var(--green)}
.insider-summary-card.buy .value{color:var(--green)}
.insider-summary-card.sell{border-left:3px solid var(--red)}
.insider-summary-card.sell .value{color:var(--red)}
.insider-summary-card.cluster{border-left:3px solid var(--yellow)}
.insider-summary-card.cluster .value{color:var(--yellow)}
.insider-row-buy{border-left:3px solid var(--green)}
.insider-row-sell{border-left:3px solid var(--red)}
.insider-type-badge{display:inline-block;padding:2px 10px;border-radius:10px;font-size:11px;font-weight:700;text-transform:uppercase}
.insider-type-badge.buy{background:rgba(63,185,80,.15);color:var(--green)}
.insider-type-badge.sell{background:rgba(248,81,73,.15);color:var(--red)}
.cluster-alert{background:var(--surface);border:1px solid var(--yellow);border-radius:var(--radius);padding:14px 18px;font-size:14px;line-height:1.5}
.insider-filter-chip{padding:4px 12px;border-radius:16px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text2);transition:all .2s}
.insider-filter-chip:hover,.insider-filter-chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.insights-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:20px}
.insights-panel h3{margin:0 0 12px;font-size:15px;font-weight:700;color:var(--text)}
.insight-row{padding:6px 10px;margin-bottom:6px;border-left:3px solid var(--text2);border-radius:2px;font-size:13px;line-height:1.5;color:var(--text)}
.insight-row.green{border-left-color:var(--green);color:var(--green)}
.insight-row.yellow{border-left-color:var(--yellow);color:var(--yellow)}
.insight-row.grey{border-left-color:var(--text2);color:var(--text2);font-style:italic}

/* ===== MOBILE RESPONSIVE ===== */
@media(max-width:768px){
  header{padding:10px 14px}
  header h1{font-size:16px}
  .btn{padding:6px 12px;font-size:13px}

  .top-tabs{padding:0 8px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .top-tabs::-webkit-scrollbar{display:none}
  .top-tab{padding:10px 14px;font-size:13px;white-space:nowrap}

  .sub-tabs{padding:0 8px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .sub-tabs::-webkit-scrollbar{display:none}
  .sub-tab{padding:6px 12px;font-size:12px;white-space:nowrap}

  /* Task board: vertical stack */
  .board{flex-direction:column;padding:12px;gap:12px;overflow-y:auto;overflow-x:hidden}
  .column{min-width:100%;width:100%;max-height:none}
  .column-body{max-height:200px;overflow-y:auto}
  .card{padding:10px}
  .card-title{font-size:13px}
  .card-desc{font-size:11px}

  /* Projects */
  .sub-section{padding:12px!important}
  .projects-grid{grid-template-columns:1fr!important;gap:12px}
  .project-card{padding:14px}
  .project-name{font-size:14px}
  .project-desc{font-size:12px}
  .project-footer{grid-template-columns:auto 70px 1fr!important;gap:6px;font-size:11px}
  .review-badge{min-width:70px!important;max-width:70px!important;font-size:10px!important}

  /* Tickers */
  .ticker-bar{gap:6px}
  .ticker-chip{padding:4px 10px;font-size:12px}
  .add-ticker-form{flex-wrap:wrap;gap:4px}
  .add-ticker-form input{width:70px;font-size:12px;padding:4px 8px}

  /* Briefings */
  .briefing-date-header{padding:10px 14px;font-size:13px;flex-wrap:wrap;gap:4px}
  .briefing-body{padding:14px}
  .briefing-body .summary{font-size:13px}
  .briefing-body .stock-row{grid-template-columns:60px 60px 1fr;gap:8px;font-size:12px;padding:6px 0}

  /* Earnings table ‚Äî sticky first column */
  .earnings-table{font-size:11px}
  .earnings-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0;padding:0}
  .earnings-table th,.earnings-table td{padding:8px 8px;white-space:nowrap}
  .earnings-table th:first-child,.earnings-table td:first-child{position:sticky;left:0;z-index:2;background:var(--surface);clip-path:inset(0 -1px 0 0);border-right:2px solid var(--border)}
  .earnings-table tr:hover td:first-child{background:var(--surface2)}
  .earnings-table th:nth-child(4),.earnings-table th:nth-child(5){min-width:140px!important}

  /* Market cards */
  .market-cards{grid-template-columns:1fr!important;gap:10px}
  .market-card{padding:14px}
  .market-title{font-size:14px}
  .market-desc{font-size:12px}
  .market-thesis{font-size:11px;padding:6px 10px}

  /* Modal */
  .modal{width:95vw;padding:18px}
  .modal h2{font-size:16px}
}

/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;width:420px;max-width:90vw}
.modal h2{margin-bottom:16px;font-size:18px}
.modal label{display:block;font-size:13px;color:var(--text2);margin-bottom:4px;margin-top:12px}
.modal input,.modal textarea,.modal select{width:100%;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:14px;font-family:inherit}
.modal textarea{resize:vertical;height:80px}
.day-check{display:inline-flex;align-items:center;gap:3px;font-size:13px;color:var(--text);cursor:pointer;padding:4px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius)}
.day-check input:checked+span,.day-check:has(input:checked){background:var(--accent);border-color:var(--accent);color:#fff}
.day-check input{accent-color:var(--accent)}
.modal-btns{display:flex;gap:8px;margin-top:20px;justify-content:flex-end}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border);padding:8px 16px;border-radius:var(--radius);cursor:pointer;font-size:14px}
</style>
</head>
<body>
<header>
  <h1><span>‚ñ¶</span> Jarvis Dashboard</h1>
  <div class="header-right">
    <button class="btn" id="actionBtn" onclick="openModal()">+ New Task</button>
  </div>
</header>

<!-- Top-level tabs -->
<div class="top-tabs">
  <div class="top-tab active" onclick="switchSection('pm')">üìã Project Management</div>
  <div class="top-tab" onclick="switchSection('stocks')">üìà Stock Updates</div>
</div>

<!-- PROJECT MANAGEMENT SECTION -->
<div class="section active" id="sectionPM">
  <div class="sub-tabs" id="pmSubTabs">
    <div class="sub-tab active" onclick="switchPMTab('tasks')">Tasks</div>
    <div class="sub-tab" onclick="switchPMTab('projects')">Projects</div>
  </div>
  <div class="board" id="board"></div>
  <div class="sub-section" id="projectsView">
    <div class="projects-grid" id="projectsGrid"></div>
  </div>
</div>

<!-- STOCK UPDATES SECTION -->
<div class="section" id="sectionStocks">
  <div class="sub-tabs" id="stockSubTabs">
    <div class="sub-tab active" onclick="switchStockTab('summary')">‚ö° Summary</div>
    <div class="sub-tab" onclick="switchStockTab('market')">üîç Market</div>
    <div class="sub-tab" onclick="switchStockTab('portfolio')">üíº Portfolio</div>
    <div class="sub-tab" onclick="switchStockTab('watchlist')">üëÅ Watchlist</div>
    <div class="sub-tab" onclick="switchStockTab('earnings')">üìÖ Earnings Calendar</div>
    <div class="sub-tab" onclick="switchStockTab('insider')">üèõÔ∏è Insider</div>
    <div class="sub-tab" onclick="switchStockTab('options')" id="optionsTab">üìä Options Flow</div>
  </div>

  <!-- Portfolio -->
  <div class="sub-section" id="portfolioView">
    <h3 style="font-size:16px;margin-bottom:16px">Your Holdings</h3>
    <div class="ticker-bar" id="tickerBar"></div>
    <h3 style="font-size:16px;margin-bottom:16px">üìä Daily Briefings</h3>
    <div class="briefing-list" id="briefingList"></div>
  </div>

  <!-- Watchlist -->
  <div class="sub-section" id="watchlistView">
    <h3 style="font-size:16px;margin-bottom:16px">Watchlist</h3>
    <div class="ticker-bar" id="watchlistBar"></div>
    <h3 style="font-size:16px;margin-bottom:16px">üìä Watchlist Briefings</h3>
    <div class="briefing-list" id="watchlistBriefingList"></div>
  </div>

  <!-- Earnings Calendar -->
  <div class="sub-section" id="earningsView">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <h3 style="font-size:16px">üìÖ Earnings Calendar</h3>
      <span style="font-size:12px;color:var(--text2)" id="earningsLastUpdated"></span>
    </div>
    <div class="earnings-scroll" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius)">
      <table class="earnings-table" id="earningsTable">
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Report Date</th>
            <th>Status</th>
            <th style="min-width:200px">üìà Bull Case</th>
            <th style="min-width:200px">üìâ Bear Case</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="earningsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Insider Trading -->
  <div class="sub-section" id="insiderView">
    <div id="insiderSummaryCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-bottom:20px"></div>
    <div id="insiderInsights" class="insights-panel" style="display:none"></div>
    <div id="insiderClusterAlerts" style="margin-bottom:20px"></div>
    <div id="insiderFilterChips" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px"></div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow-x:auto">
      <table class="earnings-table" id="insiderTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Ticker</th>
            <th>Insider</th>
            <th>Role</th>
            <th>Type</th>
            <th>Shares</th>
            <th>Price</th>
            <th>Value</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="insiderBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Options Flow -->
  <div class="sub-section" id="optionsView">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
      <div>
        <h3 style="font-size:16px;margin-bottom:4px">üìä Options Flow ‚Äî Unusual Activity</h3>
        <div class="options-scan-time" id="optionsScanTime">Not yet scanned</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="optionsFilterSentiment" onchange="renderOptions()" style="padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:12px">
          <option value="all">All Signals</option>
          <option value="bullish">üü¢ Bullish Only</option>
          <option value="bearish">üî¥ Bearish Only</option>
        </select>
        <select id="optionsFilterScore" onchange="renderOptions()" style="padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:12px">
          <option value="0">All Scores</option>
          <option value="50">Score ‚â• 50</option>
          <option value="70">Score ‚â• 70 üî•</option>
        </select>
      </div>
    </div>

    <!-- Plain-English Summary -->
    <div id="optionsSummaryBar" style="margin-bottom:20px"></div>

    <!-- What This Means glossary (collapsible) -->
    <div style="margin-bottom:20px">
      <div onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'grid':'none'" style="cursor:pointer;display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);font-size:13px;font-weight:600;color:var(--text2);user-select:none">
        <span>üìñ What do these terms mean?</span><span style="margin-left:auto;font-size:11px">click to expand</span>
      </div>
      <div style="display:none;grid-template-columns:1fr 1fr;gap:8px;padding:14px;background:var(--surface);border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius) var(--radius)">
        <div style="padding:10px;background:var(--bg);border-radius:8px"><div style="font-weight:700;font-size:12px;margin-bottom:4px">üìà CALL</div><div style="font-size:12px;color:var(--text2);line-height:1.5">A bet the stock goes <strong>UP</strong>. Someone thinks the price will rise above the strike before expiry. Unusual call volume = bullish signal.</div></div>
        <div style="padding:10px;background:var(--bg);border-radius:8px"><div style="font-weight:700;font-size:12px;margin-bottom:4px">üìâ PUT</div><div style="font-size:12px;color:var(--text2);line-height:1.5">A bet the stock goes <strong>DOWN</strong>. Someone thinks the price will fall below the strike before expiry. Unusual put volume = bearish signal.</div></div>
        <div style="padding:10px;background:var(--bg);border-radius:8px"><div style="font-weight:700;font-size:12px;margin-bottom:4px">üéØ STRIKE</div><div style="font-size:12px;color:var(--text2);line-height:1.5">The target price. A $43 CALL on IREN means the bet pays off if IREN is above $43 at expiry.</div></div>
        <div style="padding:10px;background:var(--bg);border-radius:8px"><div style="font-weight:700;font-size:12px;margin-bottom:4px">üìÖ EXPIRY</div><div style="font-size:12px;color:var(--text2);line-height:1.5">The deadline. If the stock doesn't move the right direction by this date, the contract expires worthless.</div></div>
        <div style="padding:10px;background:var(--bg);border-radius:8px"><div style="font-weight:700;font-size:12px;margin-bottom:4px">üìä VOLUME</div><div style="font-size:12px;color:var(--text2);line-height:1.5">How many contracts traded <strong>today</strong>. High volume means lots of people are betting on this contract right now.</div></div>
        <div style="padding:10px;background:var(--bg);border-radius:8px"><div style="font-weight:700;font-size:12px;margin-bottom:4px">üìÇ OI (Open Interest)</div><div style="font-size:12px;color:var(--text2);line-height:1.5">How many contracts already existed before today. Low OI + high volume = a brand new, fresh bet being opened.</div></div>
        <div style="padding:10px;background:var(--bg);border-radius:8px"><div style="font-weight:700;font-size:12px;margin-bottom:4px">‚ö° VOL/OI RATIO</div><div style="font-size:12px;color:var(--text2);line-height:1.5">The key signal. Volume √∑ OI. A 14x ratio means 14x more contracts traded today than existed ‚Äî someone is making a massive, intentional new bet. Higher = more unusual.</div></div>
        <div style="padding:10px;background:var(--bg);border-radius:8px"><div style="font-weight:700;font-size:12px;margin-bottom:4px">üí∞ PREMIUM</div><div style="font-size:12px;color:var(--text2);line-height:1.5">Total dollars spent on those contracts. $1.2M means someone put $1.2M behind this single bet. Big premium = serious conviction.</div></div>
        <div style="padding:10px;background:var(--bg);border-radius:8px"><div style="font-weight:700;font-size:12px;margin-bottom:4px">üå°Ô∏è IV (Implied Volatility)</div><div style="font-size:12px;color:var(--text2);line-height:1.5">How much movement the market expects. High IV means options are expensive because a big price swing is anticipated.</div></div>
        <div style="padding:10px;background:var(--bg);border-radius:8px"><div style="font-weight:700;font-size:12px;margin-bottom:4px">üèÜ SCORE</div><div style="font-size:12px;color:var(--text2);line-height:1.5">Jarvis's conviction score combining all signals. <strong>70+</strong> = üî• high conviction. <strong>50-69</strong> = notable. <strong>&lt;50</strong> = weak signal.</div></div>
      </div>
    </div>

    <div id="optionsAlertsList"></div>
    <div style="margin-top:20px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <h4 style="font-size:13px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px">All Unusual Contracts</h4>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow-x:auto">
        <table class="earnings-table" id="optionsTable">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Type</th>
              <th>Strike</th>
              <th>Expiry</th>
              <th>Volume</th>
              <th>OI</th>
              <th>Vol/OI</th>
              <th>Premium</th>
              <th>IV</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody id="optionsTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Summary -->
  <div class="sub-section active" id="summaryView">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
      <div>
        <h3 style="font-size:16px;margin-bottom:4px">‚ö° Jarvis's Daily Briefing</h3>
        <div style="font-size:12px;color:var(--text2)" id="summaryUpdatedAt">Loading...</div>
      </div>
    </div>
    <div id="summaryContent"><div style="text-align:center;padding:60px 20px;color:var(--text2)">Loading...</div></div>
  </div>

  <!-- Market Insights -->
  <div class="sub-section" id="marketView">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <h3 style="font-size:16px">üîç Market Shifts & Early Opportunities</h3>
    </div>
    <div id="marketList"></div>
  </div>
</div>

<!-- Task Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2 id="modalTitle">New Task</h2>
    <label>Title</label><input id="fTitle" placeholder="Task title">
    <label>Description</label><textarea id="fDesc" placeholder="Optional description"></textarea>
    <label>Priority</label>
    <select id="fPriority"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select>
    <label>Column</label>
    <select id="fColumn" onchange="toggleScheduleDate()"><option value="backlog">Backlog</option><option value="inprogress">In Progress</option><option value="review">Review</option><option value="done">Done</option><option value="recurring">Recurring</option></select>
    <div id="normalScheduleWrap">
    <label>Schedule</label>
    <select id="fScheduleType" onchange="toggleScheduleDate()"><option value="instant">Instant</option><option value="scheduled">Scheduled</option></select>
    </div>
    <div id="scheduleDateWrap" style="display:none"><label>Deadline</label><input type="datetime-local" id="fScheduleDate"></div>
    <div id="recurringWrap" style="display:none">
      <label>Frequency</label>
      <select id="fRecurFreq" onchange="toggleRecurringFields()">
        <option value="">‚Äî Select ‚Äî</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="custom">Custom (cron)</option>
      </select>
      <div id="recurDaysWrap" style="display:none">
        <label>Days</label>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px">
          <label class="day-check"><input type="checkbox" value="1" class="recurDay"> Mon</label>
          <label class="day-check"><input type="checkbox" value="2" class="recurDay"> Tue</label>
          <label class="day-check"><input type="checkbox" value="3" class="recurDay"> Wed</label>
          <label class="day-check"><input type="checkbox" value="4" class="recurDay"> Thu</label>
          <label class="day-check"><input type="checkbox" value="5" class="recurDay"> Fri</label>
          <label class="day-check"><input type="checkbox" value="6" class="recurDay"> Sat</label>
          <label class="day-check"><input type="checkbox" value="0" class="recurDay"> Sun</label>
        </div>
      </div>
      <div id="recurMonthDayWrap" style="display:none">
        <label>Day of Month</label>
        <input type="number" id="fRecurMonthDay" min="1" max="31" placeholder="1-31">
      </div>
      <div id="recurTimeWrap" style="display:none">
        <label>Time (PST)</label>
        <input type="time" id="fRecurTime" value="09:00">
      </div>
      <div id="recurCronWrap" style="display:none">
        <label>Cron Expression (5-field)</label>
        <input id="fRecurCron" placeholder="0 9 * * 1-5">
      </div>
    </div>
    <div class="modal-btns">
      <button class="btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn" id="modalSave" onclick="saveTask()">Create</button>
    </div>
  </div>
</div>

<!-- Project Modal -->
<div class="modal-overlay" id="projectModal">
  <div class="modal">
    <h2 id="projectModalTitle">New Project</h2>
    <label>Name</label><input id="pName" placeholder="Project name">
    <label>Description</label><textarea id="pDesc" placeholder="What does this project do?"></textarea>
    <label>Category</label>
    <select id="pCategory"><option value="websites">üåê Websites</option><option value="research">üîç Research</option><option value="tools">üõ†Ô∏è Tools</option><option value="other">üì¶ Other</option></select>
    <label>Status</label>
    <select id="pStatus" onchange="toggleIncompleteReason()"><option value="active">Active</option><option value="completed">Completed</option><option value="incomplete">Incomplete</option></select>
    <div id="incompleteReasonWrap" style="display:none"><label>Reason</label><input id="pIncompleteReason" placeholder="Why is it incomplete?"></div>
    <label>GitHub URL</label><input id="pGithub" placeholder="https://github.com/...">
    <label>Website / File</label><input id="pLocal" placeholder="http://localhost:3334 or file path">
    <div class="modal-btns">
      <button class="btn-ghost" onclick="closeProjectModal()">Cancel</button>
      <button class="btn" id="projectModalSave" onclick="saveProject()">Create</button>
    </div>
  </div>
</div>

<script>
const COLS=[{id:'backlog',name:'Backlog'},{id:'inprogress',name:'In Progress'},{id:'review',name:'Review'},{id:'done',name:'Done'},{id:'recurring',name:'Recurring'}];
let tasks=[], projects=[], stocksData={tickers:[],watchlist:[],earnings:[],briefings:[]}, editId=null, editProjectId=null;
let currentSection='pm', currentPMTab='tasks', currentStockTab='portfolio';

// --- Section switching ---
function switchSection(section){
  currentSection=section;
  document.querySelectorAll('.top-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.top-tab')[section==='pm'?0:1].classList.add('active');
  document.getElementById('sectionPM').classList.toggle('active',section==='pm');
  document.getElementById('sectionStocks').classList.toggle('active',section==='stocks');
  const btn=document.getElementById('actionBtn');
  if(section==='stocks'){btn.style.display='none'}
  else{btn.style.display='';updatePMBtn()}
}

function switchPMTab(tab){
  currentPMTab=tab;
  document.querySelectorAll('#pmSubTabs .sub-tab').forEach((t,i)=>t.classList.toggle('active',i===(tab==='tasks'?0:1)));
  document.getElementById('board').style.display=tab==='tasks'?'flex':'none';
  document.getElementById('projectsView').classList.toggle('active',tab==='projects');
  updatePMBtn();
}

function updatePMBtn(){
  const btn=document.getElementById('actionBtn');
  if(currentPMTab==='tasks'){btn.textContent='+ New Task';btn.onclick=openModal}
  else{btn.textContent='+ New Project';btn.onclick=openProjectModal}
}

function switchStockTab(tab){
  currentStockTab=tab;
  const tabs=['summary','market','portfolio','watchlist','earnings','insider','options'];
  document.querySelectorAll('#stockSubTabs .sub-tab').forEach((t,i)=>t.classList.toggle('active',tabs[i]===tab));
  ['summaryView','marketView','portfolioView','watchlistView','earningsView','insiderView','optionsView'].forEach((id,i)=>document.getElementById(id).classList.toggle('active',tabs[i]===tab));
  if(tab==='insider')loadInsiders();
  if(tab==='options')loadOptions();
  if(tab==='summary')loadSummary();
}

// --- Tasks ---
async function load(){tasks=await(await fetch('/api/tasks')).json();render()}

function render(){
  const board=document.getElementById('board');board.innerHTML='';
  COLS.forEach(col=>{
    const colTasks=tasks.filter(t=>t.column===col.id);
    const div=document.createElement('div');div.className='column';
    div.innerHTML=`<div class="column-header">${col.name}<span class="count">${colTasks.length}</span></div>`;
    const body=document.createElement('div');body.className='column-body';body.dataset.col=col.id;
    body.addEventListener('dragover',e=>{e.preventDefault();body.classList.add('drag-over')});
    body.addEventListener('dragleave',()=>body.classList.remove('drag-over'));
    body.addEventListener('drop',async e=>{e.preventDefault();body.classList.remove('drag-over');const id=e.dataTransfer.getData('text/plain');if(id){await fetch(`/api/tasks/${id}/move`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({column:col.id})});await load()}});
    colTasks.forEach(t=>{
      const c=document.createElement('div');c.className='card';c.draggable=true;
      if((col.id==='review'||col.id==='done')&&t.projectId){c.style.cursor='pointer';c.addEventListener('click',e=>{if(e.target.tagName==='BUTTON')return;goToProject(t)})}
      c.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',t.id);c.classList.add('dragging')});
      c.addEventListener('dragend',()=>c.classList.remove('dragging'));
      const date=new Date(t.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric'});
      c.innerHTML=`<div class="card-actions"><button onclick="editTask('${t.id}')">‚úèÔ∏è</button><button onclick="deleteTask('${t.id}')">üóë</button></div>
        <div class="card-title"><span class="priority ${t.priority}"></span>${esc(t.title)}</div>
        ${t.description?`<div class="card-desc">${esc(t.description)}</div>`:''}
        ${t.recurringSchedule?`<div class="card-meta" style="margin-bottom:4px"><span>üîÑ ${formatRecurring(t.recurringSchedule)}</span></div>`:t.schedule?`<div class="card-meta" style="margin-bottom:4px"><span>${t.schedule==='instant'?'‚ö° Instant':'üìÖ Due: '+new Date(t.schedule).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})+', '+new Date(t.schedule).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}</span></div>`:''}
        <div class="card-meta"><span>${t.assignedTo||'Jarvis'}</span><span>${date}</span></div>`;
      body.appendChild(c);
    });
    div.appendChild(body);board.appendChild(div);
  });
}

function goToProject(task){
  if(!task.projectId)return;const match=projects.find(p=>p.id===task.projectId);if(!match)return;
  switchPMTab('projects');
  setTimeout(()=>{const card=document.querySelector(`.project-card[data-id="${match.id}"]`);if(card){card.scrollIntoView({behavior:'smooth',block:'center'});card.style.outline='2px solid var(--accent)';card.style.outlineOffset='2px';setTimeout(()=>{card.style.outline='';card.style.outlineOffset=''},2000)}},100);
}

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function formatRecurring(rs){
  if(!rs)return'';
  const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const time=rs.time||'';
  const timeStr=time?new Date('2000-01-01T'+time).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}):'';
  if(rs.frequency==='daily')return'Daily at '+timeStr;
  if(rs.frequency==='weekly'){
    const days=(rs.cron||'').split(' ')[4]||'';
    const dayLabels=days.split(',').map(d=>dayNames[parseInt(d)]||d).join(', ');
    return dayLabels+' at '+timeStr;
  }
  if(rs.frequency==='monthly'){const dom=(rs.cron||'').split(' ')[2]||'1';return'Monthly on the '+dom+nth(dom)+' at '+timeStr}
  if(rs.cron)return'Cron: '+rs.cron;
  return JSON.stringify(rs);
}
function nth(d){const n=parseInt(d);if(n>3&&n<21)return'th';switch(n%10){case 1:return'st';case 2:return'nd';case 3:return'rd';default:return'th'}}
function toggleScheduleDate(){
  const col=document.getElementById('fColumn').value;
  const isRecurring=col==='recurring';
  document.getElementById('normalScheduleWrap').style.display=isRecurring?'none':'block';
  document.getElementById('scheduleDateWrap').style.display=(!isRecurring&&document.getElementById('fScheduleType').value==='scheduled')?'block':'none';
  document.getElementById('recurringWrap').style.display=isRecurring?'block':'none';
}
function toggleRecurringFields(){
  const freq=document.getElementById('fRecurFreq').value;
  document.getElementById('recurDaysWrap').style.display=freq==='weekly'?'block':'none';
  document.getElementById('recurMonthDayWrap').style.display=freq==='monthly'?'block':'none';
  document.getElementById('recurTimeWrap').style.display=(freq&&freq!=='custom')?'block':'none';
  document.getElementById('recurCronWrap').style.display=freq==='custom'?'block':'none';
}
function buildRecurringSchedule(){
  const freq=document.getElementById('fRecurFreq').value;
  if(!freq)return null;
  if(freq==='custom')return{type:'recurring',cron:document.getElementById('fRecurCron').value};
  const time=document.getElementById('fRecurTime').value||'09:00';
  const [h,m]=time.split(':').map(Number);
  let cron='';
  if(freq==='daily'){cron=`${m} ${h} * * *`}
  else if(freq==='weekly'){
    const days=[...document.querySelectorAll('.recurDay:checked')].map(c=>c.value);
    if(!days.length)return null;
    cron=`${m} ${h} * * ${days.join(',')}`;
  } else if(freq==='monthly'){
    const day=document.getElementById('fRecurMonthDay').value||'1';
    cron=`${m} ${h} ${day} * *`;
  }
  return{type:'recurring',frequency:freq,time,cron};
}
function openModal(){editId=null;document.getElementById('modalTitle').textContent='New Task';document.getElementById('modalSave').textContent='Create';['fTitle','fDesc'].forEach(id=>document.getElementById(id).value='');document.getElementById('fPriority').value='medium';document.getElementById('fColumn').value='backlog';document.getElementById('fScheduleType').value='instant';document.getElementById('fScheduleDate').value='';document.getElementById('fRecurFreq').value='';document.getElementById('fRecurTime').value='09:00';document.getElementById('fRecurCron').value='';document.getElementById('fRecurMonthDay').value='';document.querySelectorAll('.recurDay').forEach(c=>c.checked=false);toggleScheduleDate();toggleRecurringFields();document.getElementById('modal').classList.add('active')}

function editTask(id){
  const t=tasks.find(x=>x.id===id);if(!t)return;editId=id;
  document.getElementById('modalTitle').textContent='Edit Task';document.getElementById('modalSave').textContent='Save';
  document.getElementById('fTitle').value=t.title;document.getElementById('fDesc').value=t.description||'';
  document.getElementById('fPriority').value=t.priority;document.getElementById('fColumn').value=t.column;
  if(t.schedule&&t.schedule!=='instant'){document.getElementById('fScheduleType').value='scheduled';document.getElementById('fScheduleDate').value=t.schedule.slice(0,16)}else{document.getElementById('fScheduleType').value='instant';document.getElementById('fScheduleDate').value=''}
  // Load recurring schedule if present
  document.getElementById('fRecurFreq').value='';document.getElementById('fRecurTime').value='09:00';document.getElementById('fRecurCron').value='';document.getElementById('fRecurMonthDay').value='';document.querySelectorAll('.recurDay').forEach(c=>c.checked=false);
  if(t.recurringSchedule){
    const rs=t.recurringSchedule;
    document.getElementById('fRecurFreq').value=rs.frequency||'custom';
    if(rs.time)document.getElementById('fRecurTime').value=rs.time;
    if(rs.cron&&rs.frequency==='custom')document.getElementById('fRecurCron').value=rs.cron;
    if(rs.frequency==='weekly'&&rs.cron){const dayPart=rs.cron.split(' ')[4]||'';dayPart.split(',').forEach(d=>{const cb=document.querySelector(`.recurDay[value="${d}"]`);if(cb)cb.checked=true})}
    if(rs.frequency==='monthly'&&rs.cron){const dayOfMonth=rs.cron.split(' ')[2]||'';document.getElementById('fRecurMonthDay').value=dayOfMonth}
  }
  toggleScheduleDate();toggleRecurringFields();document.getElementById('modal').classList.add('active');
}
function closeModal(){document.getElementById('modal').classList.remove('active')}

async function saveTask(){
  const col=document.getElementById('fColumn').value;
  const schedType=document.getElementById('fScheduleType').value;
  const schedule=col==='recurring'?null:(schedType==='instant'?'instant':document.getElementById('fScheduleDate').value||'instant');
  const data={title:document.getElementById('fTitle').value,description:document.getElementById('fDesc').value,priority:document.getElementById('fPriority').value,column:col};
  if(schedule)data.schedule=schedule;
  if(col==='recurring'){const rs=buildRecurringSchedule();if(rs)data.recurringSchedule=rs}
  if(!data.title)return;
  if(editId){await fetch(`/api/tasks/${editId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})}
  else{await fetch('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})}
  closeModal();await load();
}
async function deleteTask(id){if(confirm('Delete this task?')){await fetch(`/api/tasks/${id}`,{method:'DELETE'});await load()}}
document.getElementById('modal').addEventListener('click',e=>{if(e.target.id==='modal')closeModal()});

// --- Projects ---
async function loadProjects(){projects=await(await fetch('/api/projects')).json();renderProjects()}

function renderProjects(){
  const grid=document.getElementById('projectsGrid');grid.innerHTML='';
  const catIcons={websites:'üåê',research:'üîç',tools:'üõ†Ô∏è',other:'üì¶'};
  const catNames={websites:'Websites',research:'Research',tools:'Tools',other:'Other'};
  const grouped={};
  projects.forEach(p=>{const cat=p.category||'other';if(!grouped[cat])grouped[cat]=[];grouped[cat].push(p)});
  ['websites','research','tools','other'].forEach(cat=>{
    if(!grouped[cat]||!grouped[cat].length)return;
    const section=document.createElement('div');section.className='category-section';
    section.innerHTML=`<div class="category-header"><span class="cat-icon">${catIcons[cat]||'üì¶'}</span>${catNames[cat]||cat}<span class="cat-count">${grouped[cat].length}</span></div>`;
    const catGrid=document.createElement('div');catGrid.className='projects-grid';
    grouped[cat].sort((a,b)=>{const aR=a.reviewed?1:0,bR=b.reviewed?1:0;if(aR!==bR)return aR-bR;return(b.createdAt||'').localeCompare(a.createdAt||'')});
    grouped[cat].forEach(p=>{
      const card=document.createElement('div');card.className='project-card';card.dataset.id=p.id;
      const date=p.createdAt||'';const rawLink=p.localUrl||'';const linkUrl=rawLink.replace(/localhost/g,window.location.hostname);
      const linkIcon=cat==='research'?'üìÑ':'üåê';const linkLabel=cat==='research'?'Open PDF':'Open';
      const isReviewed=p.reviewed===true;const reviewClass=isReviewed?'reviewed':'needs-review';const reviewLabel=isReviewed?'Reviewed':'Review';
      card.innerHTML=`<div class="card-actions"><button onclick="editProject('${p.id}')">‚úèÔ∏è</button><button onclick="deleteProject('${p.id}')">üóë</button></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><div class="project-name" style="margin-bottom:0">${esc(p.name)}</div><span style="color:var(--text2);font-size:11px;white-space:nowrap;flex-shrink:0;margin-left:12px">${date}</span></div>
        ${p.description?`<div class="project-desc">${esc(p.description)}</div>`:''}
        ${p.status==='incomplete'&&p.incompleteReason?`<div class="incomplete-reason">‚ö†Ô∏è ${esc(p.incompleteReason)}</div>`:''}
        <div class="project-footer"><span class="project-status ${p.status||'active'}">${p.status||'active'}</span><span class="review-badge ${reviewClass}" onclick="event.stopPropagation();toggleReview('${p.id}')" title="Click to toggle">${reviewLabel}</span><span class="project-links">${p.githubUrl?`<a class="project-link" href="${esc(p.githubUrl)}" target="_blank" title="GitHub">üîó</a>`:''}${linkUrl?`<a class="project-link" href="${esc(linkUrl)}" target="_blank" title="${linkLabel}">${linkIcon}</a>`:''}${linkUrl&&cat==='research'?`<a class="project-link" href="${esc(linkUrl.startsWith('/files/')?linkUrl:'/api/download?url='+encodeURIComponent(linkUrl)+'&filename='+encodeURIComponent(esc(p.name).replace(/[^a-zA-Z0-9-_ ]/g,'')+'.pdf'))}" title="Download">‚¨áÔ∏è</a>`:''}</span></div>`;
      catGrid.appendChild(card);
    });
    section.appendChild(catGrid);grid.appendChild(section);
  });
}

function toggleIncompleteReason(){document.getElementById('incompleteReasonWrap').style.display=document.getElementById('pStatus').value==='incomplete'?'block':'none'}
function openProjectModal(){editProjectId=null;document.getElementById('projectModalTitle').textContent='New Project';document.getElementById('projectModalSave').textContent='Create';['pName','pDesc','pGithub','pLocal','pIncompleteReason'].forEach(id=>document.getElementById(id).value='');document.getElementById('pCategory').value='websites';document.getElementById('pStatus').value='active';toggleIncompleteReason();document.getElementById('projectModal').classList.add('active')}

function editProject(id){
  const p=projects.find(x=>x.id===id);if(!p)return;editProjectId=id;
  document.getElementById('projectModalTitle').textContent='Edit Project';document.getElementById('projectModalSave').textContent='Save';
  document.getElementById('pName').value=p.name||'';document.getElementById('pDesc').value=p.description||'';
  document.getElementById('pCategory').value=p.category||'other';document.getElementById('pStatus').value=p.status||'active';
  document.getElementById('pGithub').value=p.githubUrl||'';document.getElementById('pLocal').value=p.localUrl||p.filePath||'';
  document.getElementById('pIncompleteReason').value=p.incompleteReason||'';toggleIncompleteReason();document.getElementById('projectModal').classList.add('active');
}
function closeProjectModal(){document.getElementById('projectModal').classList.remove('active')}

async function saveProject(){
  const status=document.getElementById('pStatus').value;
  const data={name:document.getElementById('pName').value,description:document.getElementById('pDesc').value,category:document.getElementById('pCategory').value,status,githubUrl:document.getElementById('pGithub').value,localUrl:document.getElementById('pLocal').value,incompleteReason:status==='incomplete'?document.getElementById('pIncompleteReason').value:''};
  if(!data.name)return;
  if(editProjectId){await fetch(`/api/projects/${editProjectId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})}
  else{await fetch('/api/projects',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})}
  closeProjectModal();await loadProjects();
}
async function toggleReview(id){const p=projects.find(x=>x.id===id);if(!p)return;await fetch(`/api/projects/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({reviewed:!p.reviewed})});await loadProjects()}
async function deleteProject(id){if(confirm('Delete this project?')){await fetch(`/api/projects/${id}`,{method:'DELETE'});await loadProjects()}}
document.getElementById('projectModal').addEventListener('click',e=>{if(e.target.id==='projectModal')closeProjectModal()});

// --- Stocks ---
async function loadStocks(){stocksData=await(await fetch('/api/stocks')).json();if(!stocksData.watchlist)stocksData.watchlist=[];if(!stocksData.earnings)stocksData.earnings=[];if(!stocksData.market)stocksData.market=[];renderTickers();renderWatchlist();renderBriefings();renderWatchlistBriefings();renderEarnings();renderMarket()}

function renderTickers(){
  const bar=document.getElementById('tickerBar');bar.innerHTML='';
  stocksData.tickers.forEach(t=>{
    const chip=document.createElement('div');chip.className='ticker-chip';
    chip.innerHTML=`${esc(t.symbol)} <span class="currency">${t.currency}</span><button class="remove-ticker" onclick="removeTicker('${esc(t.symbol)}')" title="Remove">√ó</button>`;
    bar.appendChild(chip);
  });
  const form=document.createElement('div');form.className='add-ticker-form';
  form.innerHTML=`<input id="newTickerSymbol" placeholder="AAPL" onkeydown="if(event.key==='Enter')addTicker()"><select id="newTickerCurrency"><option value="USD">USD</option><option value="CAD">CAD</option></select><button class="btn btn-sm" onclick="addTicker()">+ Add</button>`;
  bar.appendChild(form);
}

function renderWatchlist(){
  const bar=document.getElementById('watchlistBar');bar.innerHTML='';
  (stocksData.watchlist||[]).forEach(t=>{
    const chip=document.createElement('div');chip.className='ticker-chip';
    chip.innerHTML=`${esc(t.symbol)} <span class="currency">${t.currency}</span><button class="remove-ticker" onclick="removeWatchlistTicker('${esc(t.symbol)}')" title="Remove">√ó</button>`;
    bar.appendChild(chip);
  });
  const form=document.createElement('div');form.className='add-ticker-form';
  form.innerHTML=`<input id="newWatchlistSymbol" placeholder="NVDA" onkeydown="if(event.key==='Enter')addWatchlistTicker()"><select id="newWatchlistCurrency"><option value="USD">USD</option><option value="CAD">CAD</option></select><button class="btn btn-sm" onclick="addWatchlistTicker()">+ Add</button>`;
  bar.appendChild(form);
}

async function addTicker(){
  const sym=document.getElementById('newTickerSymbol').value.trim();const cur=document.getElementById('newTickerCurrency').value;
  if(!sym)return;await fetch('/api/stocks/tickers',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({symbol:sym,currency:cur})});document.getElementById('newTickerSymbol').value='';await loadStocks();
}
async function removeTicker(symbol){if(!confirm(`Remove ${symbol}?`))return;await fetch(`/api/stocks/tickers/${symbol}`,{method:'DELETE'});await loadStocks()}

async function addWatchlistTicker(){
  const sym=document.getElementById('newWatchlistSymbol').value.trim();const cur=document.getElementById('newWatchlistCurrency').value;
  if(!sym)return;await fetch('/api/stocks/watchlist',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({symbol:sym,currency:cur})});document.getElementById('newWatchlistSymbol').value='';await loadStocks();
}
async function removeWatchlistTicker(symbol){if(!confirm(`Remove ${symbol} from watchlist?`))return;await fetch(`/api/stocks/watchlist/${symbol}`,{method:'DELETE'});await loadStocks()}

function renderBriefings(){
  const list=document.getElementById('briefingList');list.innerHTML='';
  const portfolioBriefings=(stocksData.briefings||[]).filter(b=>b.type!=='watchlist');
  if(!portfolioBriefings.length){list.innerHTML=`<div class="no-briefings"><div class="icon">üìà</div><p>No briefings yet. Your first daily briefing arrives at 8:00 AM PST.</p></div>`;return}
  portfolioBriefings.forEach(b=>list.appendChild(buildBriefingCard(b)));
}

function renderWatchlistBriefings(){
  const list=document.getElementById('watchlistBriefingList');list.innerHTML='';
  const wBriefings=(stocksData.briefings||[]).filter(b=>b.type==='watchlist');
  if(!wBriefings.length){list.innerHTML=`<div class="no-briefings"><div class="icon">üëÅ</div><p>No watchlist briefings yet. Add tickers and they'll appear in your next morning brief.</p></div>`;return}
  wBriefings.forEach(b=>list.appendChild(buildBriefingCard(b)));
}

function buildBriefingCard(b){
  const card=document.createElement('div');card.className='briefing-card';
  const dateStr=new Date(b.date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
  const timeStr=b.createdAt?new Date(b.createdAt).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}):'';
  let stockRows='';
  if(b.stocks&&b.stocks.length){stockRows=b.stocks.map(s=>{const cc=s.change>0?'up':s.change<0?'down':'flat';const cs=s.change>0?`+${s.change}%`:`${s.change}%`;return`<div class="stock-row"><span class="stock-symbol">${esc(s.symbol)}</span><span class="stock-change ${cc}">${cs}</span><span class="stock-note">${esc(s.note||'')}</span></div>`}).join('')}
  card.innerHTML=`<div class="briefing-date-header"><div class="date-label">üìä ${dateStr} <span>${timeStr}</span></div><button class="briefing-delete" onclick="deleteBriefing('${b.id}')">üóë</button></div><div class="briefing-body">${b.summary?`<div class="summary">${b.summary}</div>`:''}${stockRows?`<div style="margin-top:8px">${stockRows}</div>`:''}${b.analysis?`<div style="margin-top:16px;color:var(--text2);font-size:13px;line-height:1.6">${b.analysis}</div>`:''}</div>`;
  return card;
}

async function deleteBriefing(id){if(!confirm('Delete this briefing?'))return;await fetch(`/api/stocks/briefings/${id}`,{method:'DELETE'});await loadStocks()}

function renderEarnings(){
  const body=document.getElementById('earningsBody');body.innerHTML='';
  const earnings=stocksData.earnings||[];
  if(!earnings.length){body.innerHTML=`<tr><td colspan="6" class="earnings-empty"><div style="padding:40px">üìÖ No earnings data yet. It will be populated with your first morning briefing.</div></td></tr>`;return}
  const now=new Date();
  const sortByDate=(arr)=>[...arr].sort((a,b)=>{
    const aD=a.reportDate?new Date(a.reportDate+'T00:00:00'):null;
    const bD=b.reportDate?new Date(b.reportDate+'T00:00:00'):null;
    if(!aD&&bD)return 1;if(aD&&!bD)return -1;if(!aD&&!bD)return 0;return aD-bD;
  });
  const portfolio=sortByDate(earnings.filter(e=>e.source!=='watchlist'));
  const watchlist=sortByDate(earnings.filter(e=>e.source==='watchlist'));
  const addSection=(label,items)=>{
    if(!items.length)return;
    const hdr=document.createElement('tr');
    hdr.innerHTML=`<td colspan="6" style="padding:14px 12px 8px;font-weight:700;font-size:14px;border-bottom:2px solid var(--accent);background:var(--bg);color:var(--accent)">${label}</td>`;
    body.appendChild(hdr);
    items.forEach(e=>{
    const tr=document.createElement('tr');
    const reportDate=e.reportDate?new Date(e.reportDate+'T00:00:00'):null;
    let status='tbd',statusLabel='TBD';
    if(reportDate){
      const diff=Math.ceil((reportDate-now)/(1000*60*60*24));
      if(diff<0){status='reported';statusLabel='Reported'}
      else if(diff<=7){status='imminent';statusLabel=`In ${diff}d`}
      else{status='upcoming';statusLabel=`In ${diff}d`}
    }
    const dateDisplay=reportDate?reportDate.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'}):'Not announced';
    tr.innerHTML=`
      <td class="sym">${esc(e.symbol)}</td>
      <td class="date-cell">${dateDisplay}</td>
      <td><span class="earnings-badge ${status}">${statusLabel}</span></td>
      <td><div class="scenario"><span class="bull">${esc(e.bullCase||'‚Äî')}</span></div></td>
      <td><div class="scenario"><span class="bear">${esc(e.bearCase||'‚Äî')}</span></div></td>
      <td style="color:var(--text2);font-size:12px">${esc(e.notes||'')}</td>`;
    body.appendChild(tr);
    });
  };
  addSection('üíº Portfolio',portfolio);
  addSection('üëÅ Watchlist',watchlist);
  // Update timestamp
  const latest=earnings.reduce((max,e)=>e.updatedAt&&e.updatedAt>max?e.updatedAt:max,'');
  document.getElementById('earningsLastUpdated').textContent=latest?`Last updated: ${new Date(latest).toLocaleDateString('en-US',{month:'short',day:'numeric'})} ${new Date(latest).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}`:'';
}

// --- Market Insights ---
function renderMarket(){
  const container=document.getElementById('marketList');container.innerHTML='';
  const market=stocksData.market||[];
  if(!market.length){container.innerHTML=`<div class="no-briefings"><div class="icon">üîç</div><p>No market insights yet. They'll appear here with your morning briefing.</p></div>`;return}
  // Group by date
  const grouped={};
  market.forEach(m=>{const d=m.date||'Unknown';if(!grouped[d])grouped[d]=[];grouped[d].push(m)});
  Object.keys(grouped).sort((a,b)=>b.localeCompare(a)).forEach(date=>{
    const section=document.createElement('div');section.className='market-day';
    const dateStr=new Date(date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
    section.innerHTML=`<div class="market-day-header">üìä ${dateStr}</div>`;
    const grid=document.createElement('div');grid.className='market-cards';
    grouped[date].forEach(m=>{
      const card=document.createElement('div');card.className='market-card';
      const typeClass=m.type||'opportunity';
      const typeLabel={'shift':'Market Shift','opportunity':'Opportunity','warning':'Warning','trend':'Trend'}[typeClass]||typeClass;
      const tickers=(m.tickers||[]).map(t=>`<span class="market-ticker">${esc(t)}</span>`).join('');
      const convClass=m.conviction==='high'?'conviction-high':m.conviction==='medium'?'conviction-med':'conviction-low';
      const convLabel=(m.conviction||'').charAt(0).toUpperCase()+(m.conviction||'').slice(1);
      const convDots=m.conviction==='high'?'üü¢üü¢üü¢':m.conviction==='medium'?'üü°üü°':'‚ö™';
      card.innerHTML=`
        <div class="card-actions"><button onclick="deleteMarketInsight('${m.id}')">üóë</button></div>
        <span class="market-type-badge ${typeClass}">${typeLabel}</span>
        <div class="market-title">${esc(m.title||'')}</div>
        ${tickers?`<div class="market-tickers">${tickers}</div>`:''}
        <div class="market-desc">${esc(m.description||'')}</div>
        ${m.thesis?`<div class="market-thesis"><div class="label">Thesis</div>${esc(m.thesis)}</div>`:''}
        ${m.conviction?`<div class="market-conviction ${convClass}">${convDots} ${convLabel} Conviction</div>`:''}`;
      grid.appendChild(card);
    });
    section.appendChild(grid);container.appendChild(section);
  });
}

async function deleteMarketInsight(id){if(!confirm('Delete this insight?'))return;await fetch(`/api/stocks/market/${id}`,{method:'DELETE'});await loadStocks()}

// --- Insider Trading ---
let insiderData=[], insiderSummary={alerts:[]}, insiderFilter=null;

async function loadInsiders(){
  try{
    const[txns,summary]=await Promise.all([
      fetch('/api/stocks/insiders').then(r=>r.json()),
      fetch('/api/stocks/insiders/summary').then(r=>r.json())
    ]);
    insiderData=txns;insiderSummary=summary;
    let earningsData=[];
    try{earningsData=await fetch('/api/stocks/earnings').then(r=>r.json())}catch(e){}
    renderInsiders();
    renderInsights(earningsData);
  }catch(e){console.error('Failed to load insiders',e)}
}

function formatDollar(val){
  if(val>=1e6)return'$'+(val/1e6).toFixed(1)+'M';
  if(val>=1e3)return'$'+(val/1e3).toFixed(0)+'K';
  return'$'+val.toFixed(0);
}

function renderInsiders(){
  const now=new Date();const thirtyAgo=new Date(now-30*24*60*60*1000);
  const recent=insiderData.filter(t=>new Date(t.date)>=thirtyAgo);
  const buys=recent.filter(t=>t.type==='BUY');
  const sells=recent.filter(t=>t.type==='SELL');
  const buyVal=buys.reduce((s,t)=>s+(t.totalValue||0),0);
  const sellVal=sells.reduce((s,t)=>s+(t.totalValue||0),0);
  const alerts=insiderSummary.alerts||[];

  // Summary cards
  document.getElementById('insiderSummaryCards').innerHTML=`
    <div class="insider-summary-card buy"><div class="label">Insider Buys (30d)</div><div class="value">${buys.length}</div><div class="sub">${formatDollar(buyVal)}</div></div>
    <div class="insider-summary-card sell"><div class="label">Insider Sells (30d)</div><div class="value">${sells.length}</div><div class="sub">${formatDollar(sellVal)}</div></div>
    <div class="insider-summary-card cluster"><div class="label">Cluster Alerts</div><div class="value">${alerts.length}</div><div class="sub">2+ insiders, 14 days</div></div>`;

  // Cluster alerts
  const alertsHtml=alerts.map(a=>{
    const verb=a.type==='BUY'?'bought':'sold';
    const emoji=a.type==='BUY'?'üî•':'‚ö†Ô∏è';
    return`<div class="cluster-alert">${emoji} <strong>${a.count} insiders ${verb} ${a.symbol}</strong> in the last 14 days ‚Äî ${formatDollar(a.totalValue)} total</div>`;
  }).join('');
  document.getElementById('insiderClusterAlerts').innerHTML=alertsHtml;

  // Filter chips
  const tickers=[...new Set(insiderData.map(t=>t.symbol))].sort();
  const chipsHtml=`<div class="insider-filter-chip ${!insiderFilter?'active':''}" onclick="setInsiderFilter(null)">All</div>`+
    tickers.map(t=>`<div class="insider-filter-chip ${insiderFilter===t?'active':''}" onclick="setInsiderFilter('${t}')">${t}</div>`).join('');
  document.getElementById('insiderFilterChips').innerHTML=chipsHtml;

  // Table
  const filtered=insiderFilter?insiderData.filter(t=>t.symbol===insiderFilter):insiderData;
  const body=document.getElementById('insiderBody');
  if(!filtered.length){
    body.innerHTML=`<tr><td colspan="9" style="text-align:center;padding:60px 20px;color:var(--text2)"><div style="font-size:48px;margin-bottom:12px">üèõÔ∏è</div><p>No insider transactions yet. Run fetch-insiders.js to populate data.</p></td></tr>`;
    return;
  }
  body.innerHTML=filtered.map(t=>{
    const rowClass=t.type==='BUY'?'insider-row-buy':'insider-row-sell';
    const typeClass=t.type==='BUY'?'buy':'sell';
    const dateStr=new Date(t.date+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
    return`<tr class="${rowClass}">
      <td style="white-space:nowrap">${dateStr}</td>
      <td style="font-weight:700">${esc(t.symbol)}</td>
      <td>${esc(t.insiderName)}</td>
      <td style="color:var(--text2);font-size:12px">${esc(t.role||'')}</td>
      <td><span class="insider-type-badge ${typeClass}">${t.type}</span></td>
      <td style="text-align:right">${(t.shares||0).toLocaleString()}</td>
      <td style="text-align:right">$${(t.pricePerShare||0).toFixed(2)}</td>
      <td style="text-align:right;font-weight:600">${formatDollar(t.totalValue||0)}</td>
      <td><button onclick="deleteInsider('${t.id}')" style="background:none;border:none;color:var(--text2);cursor:pointer;font-size:13px" title="Delete">üóë</button></td>
    </tr>`;
  }).join('');
}

function renderInsights(earningsData){
  const panel=document.getElementById('insiderInsights');
  const insights=[];
  const megaCaps=['NVDA','MSFT','MU','AAPL','GOOGL','AMZN','META','TSLA'];
  const now=new Date();const thirtyAgo=new Date(now-30*24*60*60*1000);
  const recent=insiderData.filter(t=>new Date(t.date)>=thirtyAgo);
  const buys=recent.filter(t=>t.type==='BUY');
  const sells=recent.filter(t=>t.type==='SELL');

  // Earnings map: symbol ‚Üí nearest future date
  const earningsMap={};
  (earningsData||[]).forEach(e=>{
    const d=new Date(e.date||e.earningsDate);
    if(d>=now&&(!earningsMap[e.symbol]||d<earningsMap[e.symbol]))earningsMap[e.symbol]=d;
  });

  // Insider buys
  buys.forEach(t=>{
    insights.push({type:'green',text:`üü¢ Insider buy detected ‚Äî ${esc(t.insiderName)} bought ${esc(t.symbol)}. Insiders only buy when they're bullish.`});
  });

  // Cluster alerts from summary
  const alerts=insiderSummary.alerts||[];
  alerts.filter(a=>a.type==='SELL').forEach(a=>{
    // Check if near earnings
    const ed=earningsMap[a.symbol];
    if(ed){
      const daysTil=Math.round((ed-now)/(24*60*60*1000));
      if(daysTil>=0&&daysTil<=14){
        insights.push({type:'yellow',text:`‚ö†Ô∏è ${a.symbol} insiders selling ahead of earnings on ${ed.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ‚Äî consider tightening stop loss`});
        return;
      }
    }
    insights.push({type:'yellow',text:`‚ö†Ô∏è ${a.count} insiders sold ${a.symbol} totaling ${formatDollar(a.totalValue)} ‚Äî elevated activity worth monitoring`});
  });

  // Mega-cap routine sells
  const megaSells={};
  sells.filter(t=>megaCaps.includes(t.symbol)).forEach(t=>{megaSells[t.symbol]=(megaSells[t.symbol]||0)+1});
  Object.entries(megaSells).filter(([,c])=>c>=2).forEach(([sym])=>{
    insights.push({type:'grey',text:`${sym}: Routine compensation sales ‚Äî common for mega-cap executives with 10b5-1 plans`});
  });

  // General note
  insights.push({type:'grey',text:`Most insider sells are routine (pre-scheduled 10b5-1 plans, compensation liquidation). Insider BUYS are the stronger signal ‚Äî executives only buy with their own money when they're confident.`});

  if(insights.length<=1&&!buys.length){panel.style.display='none';return}
  panel.style.display='';
  panel.innerHTML=`<h3>üß† Insider Insights</h3>`+insights.map(i=>`<div class="insight-row ${i.type}">${i.text}</div>`).join('');
}

function setInsiderFilter(ticker){insiderFilter=ticker;renderInsiders()}
async function deleteInsider(id){if(!confirm('Delete this transaction?'))return;await fetch(`/api/stocks/insiders/${id}`,{method:'DELETE'});await loadInsiders()}

// --- Options Flow ---
let optionsData = { scannedAt: null, alerts: [] };

async function loadOptions() {
  try {
    optionsData = await fetch('/api/stocks/options').then(r => r.json());
    renderOptions();
  } catch(e) { console.error('Options load failed', e); }
}

function fmtPremium(p) {
  if (!p) return '‚Äî';
  if (p >= 1000000) return '$' + (p / 1000000).toFixed(1) + 'M';
  return '$' + (p / 1000).toFixed(0) + 'K';
}

function renderOptions() {
  const sentFilter = document.getElementById('optionsFilterSentiment')?.value || 'all';
  const scoreFilter = parseInt(document.getElementById('optionsFilterScore')?.value || '0');
  const scanEl = document.getElementById('optionsScanTime');
  const listEl = document.getElementById('optionsAlertsList');
  const tbodyEl = document.getElementById('optionsTableBody');

  // Scan time
  if (scanEl) {
    if (optionsData.scannedAt) {
      const d = new Date(optionsData.scannedAt);
      scanEl.textContent = 'Last scan: ' + d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
    } else {
      scanEl.textContent = 'No scan data yet ‚Äî run fetch-options.js to populate';
    }
  }

  let alerts = optionsData.alerts || [];
  if (sentFilter !== 'all') alerts = alerts.filter(a => a.sentiment === sentFilter);
  if (scoreFilter > 0) alerts = alerts.filter(a => a.unusualScore >= scoreFilter);

  // Update tab badge
  const tabEl = document.getElementById('optionsTab');
  const highAlerts = (optionsData.alerts || []).filter(a => a.unusualScore >= 50).length;
  if (tabEl) tabEl.textContent = highAlerts > 0 ? `üìä Options Flow (${highAlerts})` : 'üìä Options Flow';

  // Plain-English Summary Bar
  const summaryEl = document.getElementById('optionsSummaryBar');
  if (summaryEl && optionsData.scannedAt) {
    const all = optionsData.alerts || [];
    const bullishAlerts = all.filter(a => a.sentiment === 'bullish' && a.unusualScore >= 50);
    const bearishAlerts = all.filter(a => a.sentiment === 'bearish' && a.unusualScore >= 50);
    const totalPremium = all.filter(a => a.unusualScore >= 50).reduce((s, a) => s + (a.premium || 0), 0);
    // Find hottest ticker
    const tickerCounts = {};
    all.forEach(a => { tickerCounts[a.symbol] = (tickerCounts[a.symbol] || 0) + 1; });
    const hottestTicker = Object.entries(tickerCounts).sort((a,b) => b[1]-a[1])[0]?.[0] || '‚Äî';
    // Determine overall lean
    const lean = bullishAlerts.length > bearishAlerts.length ? 'üü¢ Leaning Bullish' : bullishAlerts.length < bearishAlerts.length ? 'üî¥ Leaning Bearish' : '‚öñÔ∏è Mixed Signals';
    const leanColor = bullishAlerts.length > bearishAlerts.length ? 'var(--green)' : bullishAlerts.length < bearishAlerts.length ? 'var(--red)' : 'var(--yellow)';
    // Build plain-english summary
    const topAlert = all.filter(a => a.unusualScore >= 50)[0];
    let summaryText = '';
    if (topAlert) {
      const dir = topAlert.type === 'call' ? 'bullish' : 'bearish';
      summaryText = `The biggest signal today is <strong>${topAlert.symbol}</strong> ‚Äî someone spent <strong>${fmtPremium(topAlert.premium)}</strong> betting the stock goes <strong>${dir === 'bullish' ? 'up past $' + topAlert.strike : 'down below $' + topAlert.strike}</strong> by ${topAlert.expiry}. That's ${topAlert.volOiRatio}x more contracts than normal ‚Äî a very unusual, intentional bet.`;
    }
    summaryEl.innerHTML = `
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:4px">
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:12px">üß† Plain-English Summary</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:14px">
          <div style="text-align:center;padding:10px;background:var(--bg);border-radius:8px">
            <div style="font-size:22px;font-weight:700;color:var(--green)">${bullishAlerts.length}</div>
            <div style="font-size:11px;color:var(--text2);margin-top:2px">Bullish bets</div>
          </div>
          <div style="text-align:center;padding:10px;background:var(--bg);border-radius:8px">
            <div style="font-size:22px;font-weight:700;color:var(--red)">${bearishAlerts.length}</div>
            <div style="font-size:11px;color:var(--text2);margin-top:2px">Bearish bets</div>
          </div>
          <div style="text-align:center;padding:10px;background:var(--bg);border-radius:8px">
            <div style="font-size:22px;font-weight:700;color:var(--accent)">${fmtPremium(totalPremium)}</div>
            <div style="font-size:11px;color:var(--text2);margin-top:2px">Total $ at stake</div>
          </div>
          <div style="text-align:center;padding:10px;background:var(--bg);border-radius:8px">
            <div style="font-size:22px;font-weight:700;color:var(--text)">${hottestTicker}</div>
            <div style="font-size:11px;color:var(--text2);margin-top:2px">Most active</div>
          </div>
          <div style="text-align:center;padding:10px;background:var(--bg);border-radius:8px">
            <div style="font-size:16px;font-weight:700;color:${leanColor}">${lean}</div>
            <div style="font-size:11px;color:var(--text2);margin-top:2px">Overall sentiment</div>
          </div>
        </div>
        ${summaryText ? `<div style="font-size:13px;color:var(--text2);line-height:1.6;padding:10px;background:var(--bg);border-radius:8px;border-left:3px solid var(--accent)">${summaryText}</div>` : ''}
      </div>`;
  } else if (summaryEl) {
    summaryEl.innerHTML = '';
  }

  // Top alert cards
  if (listEl) {
    const top = alerts.filter(a => a.unusualScore >= 50).slice(0, 6);
    if (top.length === 0) {
      if (alerts.length === 0 && !optionsData.scannedAt) {
        listEl.innerHTML = `<div class="options-empty">üìä No options data yet.<br><small>The daily 8:30am scan will populate this automatically on weekdays.</small></div>`;
      } else {
        listEl.innerHTML = `<div class="options-empty" style="padding:20px">No high-conviction alerts matching filters.</div>`;
      }
    } else {
      listEl.innerHTML = top.map(a => {
        const scoreClass = a.unusualScore >= 70 ? 'high' : a.unusualScore >= 50 ? 'med' : 'low';
        const itm = a.inTheMoney ? '<span style="font-size:10px;color:var(--text2);margin-left:6px">ITM</span>' : '';
        return `<div class="options-alert-card ${a.sentiment}">
          <div class="options-score ${scoreClass}">${a.unusualScore}</div>
          <div class="options-meta">
            <div><span class="sym">${a.symbol}</span> <span class="options-badge ${a.sentiment}">${a.sentiment}</span>${itm}</div>
            <div class="strike">$${a.strike} ${a.type.toUpperCase()} ¬∑ exp ${a.expiry}</div>
            <div class="options-stats">
              <div class="options-stat"><div class="val">${a.volume.toLocaleString()}</div><div class="lbl">Volume</div></div>
              <div class="options-stat"><div class="val">${a.openInterest.toLocaleString()}</div><div class="lbl">OI</div></div>
              <div class="options-stat"><div class="val">${a.volOiRatio}x</div><div class="lbl">Vol/OI</div></div>
              <div class="options-stat"><div class="val">${fmtPremium(a.premium)}</div><div class="lbl">Premium</div></div>
              ${a.impliedVolatility ? `<div class="options-stat"><div class="val">${a.impliedVolatility}%</div><div class="lbl">IV</div></div>` : ''}
            </div>
          </div>
        </div>`;
      }).join('');
    }
  }

  // Full table
  if (tbodyEl) {
    if (alerts.length === 0) {
      tbodyEl.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:30px;color:var(--text2)">No contracts match current filters</td></tr>`;
    } else {
      tbodyEl.innerHTML = alerts.map(a => {
        const scoreClass = a.unusualScore >= 70 ? 'var(--red)' : a.unusualScore >= 50 ? 'var(--yellow)' : 'var(--text2)';
        const sentColor = a.sentiment === 'bullish' ? 'var(--green)' : 'var(--red)';
        return `<tr>
          <td style="font-weight:700">${a.symbol}</td>
          <td><span class="options-badge ${a.sentiment}">${a.type.toUpperCase()}</span></td>
          <td>$${a.strike}</td>
          <td>${a.expiry}</td>
          <td style="font-weight:600">${a.volume.toLocaleString()}</td>
          <td>${a.openInterest.toLocaleString()}</td>
          <td style="color:${sentColor};font-weight:600">${a.volOiRatio}x</td>
          <td style="font-weight:600">${fmtPremium(a.premium)}</td>
          <td>${a.impliedVolatility != null ? a.impliedVolatility + '%' : '‚Äî'}</td>
          <td style="color:${scoreClass};font-weight:700">${a.unusualScore}</td>
        </tr>`;
      }).join('');
    }
  }
}

// --- Summary ---
async function loadSummary() {
  const el = document.getElementById('summaryContent');
  const upEl = document.getElementById('summaryUpdatedAt');
  if (!el) return;
  el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text2)">Loading...</div>';
  try {
    const summary = await fetch('/api/stocks/summary').then(r=>r.json()).catch(()=>null);
    if (!summary || !summary.overall) {
      el.innerHTML = '<div style="text-align:center;padding:60px 20px;color:var(--text2)"><div style="font-size:32px;margin-bottom:12px">‚ö°</div><div style="font-size:15px;font-weight:600">No briefing yet</div><div style="font-size:13px;margin-top:8px">Jarvis writes a fresh summary every weekday morning at 8:25 AM PST.</div></div>';
      if (upEl) upEl.textContent = '';
      return;
    }
    if (upEl) {
      const d = new Date(summary.updatedAt);
      upEl.textContent = 'Written by Jarvis ‚Äî ' + d.toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'}) + ' at ' + d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    }

    const verdictColors = { bullish:'#3fb950', bearish:'#f85149', mixed:'#d29922', neutral:'var(--text2)' };
    const vc = verdictColors[summary.sentiment] || 'var(--text2)';

    let html = '';

    // Overall take
    html += '<div style="padding:20px;background:var(--surface);border:1px solid var(--border);border-left:3px solid '+vc+';border-radius:8px;margin-bottom:24px">' +
      '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:8px">‚ö° Overall Take</div>' +
      '<div style="font-size:15px;line-height:1.7;color:var(--text)">'+esc(summary.overall)+'</div>' +
    '</div>';

    // Per-ticker recommendations
    if (summary.picks && summary.picks.length > 0) {
      html += '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:14px">What I\'d Do With Each Position</div>';
      summary.picks.forEach(p => {
        const colors = { buy:'#3fb950', hold:'#d29922', trim:'#f85149', sell:'#f85149', watch:'#d29922' };
        const emojis = { buy:'üü¢', hold:'‚ö†Ô∏è', trim:'üî¥', sell:'üî¥', watch:'üëÄ' };
        const ac = colors[p.action] || 'var(--text2)';
        const ae = emojis[p.action] || '‚ö°';
        html += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px">' +
          '<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">' +
            '<span style="font-size:18px;font-weight:700">'+esc(p.symbol)+'</span>' +
            '<span style="padding:2px 10px;border-radius:10px;font-size:12px;font-weight:700;background:'+ac+'22;color:'+ac+'">'+ae+' '+esc(p.action.toUpperCase())+'</span>' +
          '</div>' +
          '<div style="font-size:14px;line-height:1.7;color:var(--text)">'+esc(p.reasoning)+'</div>' +
        '</div>';
      });
    }

    // Key events
    if (summary.keyEvents && summary.keyEvents.length > 0) {
      html += '<div style="margin-top:24px;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:8px">' +
        '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:10px">üìÖ This Week</div>';
      summary.keyEvents.forEach(e => {
        html += '<div style="font-size:14px;line-height:1.7;margin-bottom:6px;color:var(--text)">'+esc(e)+'</div>';
      });
      html += '</div>';
    }

    el.innerHTML = html;
  } catch(err) {
    el.innerHTML = '<div style="padding:20px;color:#f85149">Error: ' + err.message + '</div>';
  }
}

// Init
load();loadProjects();loadStocks();loadSummary();

// Auto-refresh
setInterval(async()=>{
  try{
    const[nt,np,ns]=await Promise.all([fetch('/api/tasks').then(r=>r.json()),fetch('/api/projects').then(r=>r.json()),fetch('/api/stocks').then(r=>r.json())]);
    if(JSON.stringify(nt)!==JSON.stringify(tasks)){tasks=nt;render()}
    if(JSON.stringify(np)!==JSON.stringify(projects)){projects=np;renderProjects()}
    if(JSON.stringify(ns)!==JSON.stringify(stocksData)){stocksData=ns;renderTickers();renderWatchlist();renderBriefings();renderWatchlistBriefings();renderEarnings();renderMarket()}
  }catch(e){}
},2000);
</script>
<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.getRegistrations().then(regs=>regs.forEach(r=>r.unregister()));
}
if('caches' in window){
  caches.keys().then(keys=>keys.forEach(k=>caches.delete(k)));
}
</script>
</body>
</html>
